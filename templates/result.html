{% extends "layout.html" %}

{% block title %}Tahlil Sonucu - MediTahlil{% endblock %}

{% block extra_css %}
<!-- Chart.js kütüphanesi -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
<style>
    /* Temel stilller ve ana renkler */
    :root {
        --accent-color: #3B82F6;
        --accent-light: #EFF6FF;
        --accent-dark: #1D4ED8;
        --warning-color: #F59E0B;
        --warning-light: #FFFBEB;
        --danger-color: #EF4444;
        --danger-light: #FEF2F2;
        --success-color: #10B981;
        --success-light: #ECFDF5;
        --text-primary: #1F2937;
        --text-secondary: #6B7280;
        --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
        --hover-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    [data-bs-theme="dark"] {
        --accent-color: #3B82F6;
        --accent-light: #1E3A8A;
        --accent-dark: #60A5FA;
        --warning-color: #F59E0B;
        --warning-light: #78350F;
        --danger-color: #EF4444;
        --danger-light: #7F1D1D;
        --success-color: #10B981;
        --success-light: #064E3B;
        --text-primary: #F9FAFB;
        --text-secondary: #E5E7EB;
        --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.25), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
        --hover-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
    }
    
    /* Gövde stilleri */
    body {
        overflow-x: hidden;
    }
    
    .container {
        animation: fadeIn 0.6s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Kart ve içerik stilleri */
    .card {
        border-radius: 0.75rem !important;
        transition: all 0.3s ease !important;
        border: none !important;
        box-shadow: var(--card-shadow) !important;
    }
    
    .card:hover {
        transform: translateY(-5px) !important;
        box-shadow: var(--hover-shadow) !important;
    }
    
    .card-header {
        border-top-left-radius: 0.75rem !important;
        border-top-right-radius: 0.75rem !important;
        background-color: white !important; 
    }
    
    [data-bs-theme="dark"] .card-header {
        background-color: #1F2937 !important;
    }
    
    .analysis-result {
        line-height: 1.7;
        color: var(--text-primary);
    }
    
    [data-bs-theme="dark"] .analysis-result {
        color: var(--text-primary);
    }
    
    .analysis-result strong {
        color: var(--accent-color);
        font-weight: 600;
    }
    
    .tahlil-content {
        white-space: pre-line;
        font-size: 1.05rem;
        line-height: 1.8;
    }
    
    .tahlil-content h1, 
    .tahlil-content h2, 
    .tahlil-content h3, 
    .tahlil-content h4, 
    .tahlil-content h5, 
    .tahlil-content h6 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        color: var(--accent-color);
        font-weight: 600;
    }
    
    .tahlil-content p {
        margin-bottom: 1rem;
    }
    
    .tahlil-content ul, 
    .tahlil-content ol {
        padding-left: 2rem;
        margin-bottom: 1rem;
    }
    
    .tahlil-content li {
        margin-bottom: 0.5rem;
    }
    
    .tahlil-content strong {
        color: var(--text-primary);
        font-weight: 600;
    }
    
    [data-bs-theme="dark"] .tahlil-content strong {
        color: var(--text-secondary);
    }
    
    /* Grafik Kartları */
    .chart-card {
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .chart-card:hover {
        transform: translateY(-5px);
    }
    
    /* Değer çubukları */
    .value-gauge {
        height: 8px;
        border-radius: 12px;
        background-color: #e9ecef;
        margin: 8px 0;
        position: relative;
        overflow: hidden;
    }
    
    [data-bs-theme="dark"] .value-gauge {
        background-color: #374151;
    }
    
    .value-gauge-fill {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        border-radius: 12px;
        transition: width 1.2s cubic-bezier(0.65, 0, 0.35, 1);
    }
    
    .value-gauge-fill.normal {
        background-color: var(--success-color);
    }
    
    .value-gauge-fill.warning {
        background-color: var(--warning-color);
    }
    
    .value-gauge-fill.danger {
        background-color: var(--danger-color);
    }
    
    /* Tablo stilleri */
    .table-hover tbody tr:hover {
        background-color: var(--accent-light);
    }
    
    .table th {
        font-weight: 600;
        color: var(--text-primary);
    }
    
    /* Skor dairesi */
    .score-circle {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .score-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    
    .score-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0;
        line-height: 1;
        background: linear-gradient(45deg, var(--accent-color), var(--accent-dark));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .score-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    
    /* Karanlık mod uyumluluğu */
    [data-bs-theme="dark"] .bg-light {
        background-color: #1F2937 !important;
    }
    
    [data-bs-theme="dark"] .text-muted {
        color: #D1D5DB !important;
    }
    
    [data-bs-theme="dark"] .bg-white {
        background-color: #111827 !important;
    }
    
    /* Özel animasyonlar ve efektler */
    .badge {
        transition: all 0.3s ease;
    }
    
    .badge:hover {
        transform: scale(1.1);
    }
    
    .rotate-icon {
        transition: transform 0.3s ease;
    }
    
    .card:hover .rotate-icon {
        transform: rotate(15deg);
    }
    
    /* Özel kartlar için stil */
    .parameter-card {
        border-radius: 0.75rem;
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .parameter-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--hover-shadow);
    }
    
    .parameter-card .card-body {
        padding: 1.25rem;
    }
    
    .parameter-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, var(--accent-light), var(--accent-color));
        color: white;
        font-size: 1.25rem;
        transition: all 0.3s ease;
    }
    
    .parameter-card:hover .parameter-icon {
        transform: scale(1.1) rotate(10deg);
    }
    
    /* Yazdırma stilleri */
    @media print {
        .navbar, .footer, .btn, .accordion, .alert, .card-footer, .nav-pills {
            display: none !important;
        }
        
        .chart-container canvas {
            max-width: 100% !important;
            height: auto !important;
        }
        
        .card {
            break-inside: avoid;
            box-shadow: none !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-11">
            <!-- Üst Bilgi Kartı -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-file-medical-alt me-2 text-primary"></i>Tahlil Analiz Sonucu</h4>
                    <span class="badge bg-primary rounded-pill px-3 py-2">{{ analysis.created_at.split()[0] }}</span>
                </div>
                
                <!-- Analiz Bilgisi Kartı -->
                <div class="card-body p-4">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100 border-0 bg-light parameter-card">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">Dosya Bilgileri</h5>
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="parameter-icon">
                                            <i class="fas fa-file-pdf"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">{{ analysis.file_name }}</h6>
                                            <p class="text-muted mb-0 small">{{ analysis.created_at }}</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <span class="badge bg-primary-subtle text-primary-emphasis me-2">Kan Tahlili</span>
                                        <span class="badge bg-secondary-subtle text-secondary-emphasis">{{ test_values|length }} Parametre</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 parameter-card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">Sağlık Durumu Özeti</h5>
                                    
                                    <!-- İnsan vücudu sistemleri gösterimi -->
                                    <div class="body-systems mb-3">
                                        <div class="row g-2 text-center">
                                            <!-- Kardiyovasküler Sistem -->
                                            <div class="col-4">
                                                <div class="system-card p-2 rounded {% if abnormal_values|selectattr('parameter_name', 'search', 'Kolesterol')|list or abnormal_values|selectattr('parameter_name', 'search', 'HDL')|list or abnormal_values|selectattr('parameter_name', 'search', 'LDL')|list %}bg-warning-subtle{% else %}bg-success-subtle{% endif %}">
                                                    <div class="system-icon mb-2">
                                                        <i class="fas fa-heartbeat {% if abnormal_values|selectattr('parameter_name', 'search', 'Kolesterol')|list or abnormal_values|selectattr('parameter_name', 'search', 'HDL')|list or abnormal_values|selectattr('parameter_name', 'search', 'LDL')|list %}text-warning{% else %}text-success{% endif %} fa-2x"></i>
                                                    </div>
                                                    <div class="system-name small fw-medium">Kalp</div>
                                                    <div class="system-status fs-6">
                                                        {% if abnormal_values|selectattr('parameter_name', 'search', 'Kolesterol')|list or abnormal_values|selectattr('parameter_name', 'search', 'HDL')|list or abnormal_values|selectattr('parameter_name', 'search', 'LDL')|list %}
                                                            <i class="fas fa-exclamation-circle text-warning"></i>
                                                        {% else %}
                                                            <i class="fas fa-check-circle text-success"></i>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Karaciğer Sistemi -->
                                            <div class="col-4">
                                                <div class="system-card p-2 rounded {% if abnormal_values|selectattr('parameter_name', 'search', 'ALT')|list or abnormal_values|selectattr('parameter_name', 'search', 'AST')|list or abnormal_values|selectattr('parameter_name', 'search', 'Bilirubin')|list %}bg-warning-subtle{% else %}bg-success-subtle{% endif %}">
                                                    <div class="system-icon mb-2">
                                                        <i class="fas fa-notes-medical {% if abnormal_values|selectattr('parameter_name', 'search', 'ALT')|list or abnormal_values|selectattr('parameter_name', 'search', 'AST')|list or abnormal_values|selectattr('parameter_name', 'search', 'Bilirubin')|list %}text-warning{% else %}text-success{% endif %} fa-2x"></i>
                                                    </div>
                                                    <div class="system-name small fw-medium">Karaciğer</div>
                                                    <div class="system-status fs-6">
                                                        {% if abnormal_values|selectattr('parameter_name', 'search', 'ALT')|list or abnormal_values|selectattr('parameter_name', 'search', 'AST')|list or abnormal_values|selectattr('parameter_name', 'search', 'Bilirubin')|list %}
                                                            <i class="fas fa-exclamation-circle text-warning"></i>
                                                        {% else %}
                                                            <i class="fas fa-check-circle text-success"></i>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Böbrek Sistemi -->
                                            <div class="col-4">
                                                <div class="system-card p-2 rounded {% if abnormal_values|selectattr('parameter_name', 'search', 'Kreatinin')|list or abnormal_values|selectattr('parameter_name', 'search', 'Üre')|list or abnormal_values|selectattr('parameter_name', 'search', 'Ürik Asit')|list %}bg-warning-subtle{% else %}bg-success-subtle{% endif %}">
                                                    <div class="system-icon mb-2">
                                                        <i class="fas fa-filter {% if abnormal_values|selectattr('parameter_name', 'search', 'Kreatinin')|list or abnormal_values|selectattr('parameter_name', 'search', 'Üre')|list or abnormal_values|selectattr('parameter_name', 'search', 'Ürik Asit')|list %}text-warning{% else %}text-success{% endif %} fa-2x"></i>
                                                    </div>
                                                    <div class="system-name small fw-medium">Böbrek</div>
                                                    <div class="system-status fs-6">
                                                        {% if abnormal_values|selectattr('parameter_name', 'search', 'Kreatinin')|list or abnormal_values|selectattr('parameter_name', 'search', 'Üre')|list or abnormal_values|selectattr('parameter_name', 'search', 'Ürik Asit')|list %}
                                                            <i class="fas fa-exclamation-circle text-warning"></i>
                                                        {% else %}
                                                            <i class="fas fa-check-circle text-success"></i>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Metabolizma -->
                                            <div class="col-4 mt-2">
                                                <div class="system-card p-2 rounded {% if abnormal_values|selectattr('parameter_name', 'search', 'Glukoz')|list or abnormal_values|selectattr('parameter_name', 'search', 'HbA1c')|list or abnormal_values|selectattr('parameter_name', 'search', 'İnsülin')|list %}bg-warning-subtle{% else %}bg-success-subtle{% endif %}">
                                                    <div class="system-icon mb-2">
                                                        <i class="fas fa-apple-alt {% if abnormal_values|selectattr('parameter_name', 'search', 'Glukoz')|list or abnormal_values|selectattr('parameter_name', 'search', 'HbA1c')|list or abnormal_values|selectattr('parameter_name', 'search', 'İnsülin')|list %}text-warning{% else %}text-success{% endif %} fa-2x"></i>
                                                    </div>
                                                    <div class="system-name small fw-medium">Metabolizma</div>
                                                    <div class="system-status fs-6">
                                                        {% if abnormal_values|selectattr('parameter_name', 'search', 'Glukoz')|list or abnormal_values|selectattr('parameter_name', 'search', 'HbA1c')|list or abnormal_values|selectattr('parameter_name', 'search', 'İnsülin')|list %}
                                                            <i class="fas fa-exclamation-circle text-warning"></i>
                                                        {% else %}
                                                            <i class="fas fa-check-circle text-success"></i>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Hematoloji -->
                                            <div class="col-4 mt-2">
                                                <div class="system-card p-2 rounded {% if abnormal_values|selectattr('parameter_name', 'search', 'Hemoglobin')|list or abnormal_values|selectattr('parameter_name', 'search', 'Eritrosit')|list or abnormal_values|selectattr('parameter_name', 'search', 'Lökosit')|list %}bg-warning-subtle{% else %}bg-success-subtle{% endif %}">
                                                    <div class="system-icon mb-2">
                                                        <i class="fas fa-tint {% if abnormal_values|selectattr('parameter_name', 'search', 'Hemoglobin')|list or abnormal_values|selectattr('parameter_name', 'search', 'Eritrosit')|list or abnormal_values|selectattr('parameter_name', 'search', 'Lökosit')|list %}text-warning{% else %}text-success{% endif %} fa-2x"></i>
                                                    </div>
                                                    <div class="system-name small fw-medium">Kan</div>
                                                    <div class="system-status fs-6">
                                                        {% if abnormal_values|selectattr('parameter_name', 'search', 'Hemoglobin')|list or abnormal_values|selectattr('parameter_name', 'search', 'Eritrosit')|list or abnormal_values|selectattr('parameter_name', 'search', 'Lökosit')|list %}
                                                            <i class="fas fa-exclamation-circle text-warning"></i>
                                                        {% else %}
                                                            <i class="fas fa-check-circle text-success"></i>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Bağışıklık -->
                                            <div class="col-4 mt-2">
                                                <div class="system-card p-2 rounded {% if abnormal_values|selectattr('parameter_name', 'search', 'Lenfosit')|list or abnormal_values|selectattr('parameter_name', 'search', 'CRP')|list or abnormal_values|selectattr('parameter_name', 'search', 'Sedim')|list %}bg-warning-subtle{% else %}bg-success-subtle{% endif %}">
                                                    <div class="system-icon mb-2">
                                                        <i class="fas fa-shield-alt {% if abnormal_values|selectattr('parameter_name', 'search', 'Lenfosit')|list or abnormal_values|selectattr('parameter_name', 'search', 'CRP')|list or abnormal_values|selectattr('parameter_name', 'search', 'Sedim')|list %}text-warning{% else %}text-success{% endif %} fa-2x"></i>
                                                    </div>
                                                    <div class="system-name small fw-medium">Bağışıklık</div>
                                                    <div class="system-status fs-6">
                                                        {% if abnormal_values|selectattr('parameter_name', 'search', 'Lenfosit')|list or abnormal_values|selectattr('parameter_name', 'search', 'CRP')|list or abnormal_values|selectattr('parameter_name', 'search', 'Sedim')|list %}
                                                            <i class="fas fa-exclamation-circle text-warning"></i>
                                                        {% else %}
                                                            <i class="fas fa-check-circle text-success"></i>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Sonuç Durumu -->
                                    <div class="result-summary">
                                        <div class="d-flex align-items-center p-2 rounded-3 {% if abnormal_values %}bg-warning-subtle text-warning-emphasis{% else %}bg-success-subtle text-success-emphasis{% endif %}">
                                            <div class="me-3">
                                                {% if abnormal_values %}
                                                    <i class="fas fa-exclamation-circle fa-2x text-warning"></i>
                                                {% else %}
                                                    <i class="fas fa-check-circle fa-2x text-success"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="fw-bold">
                                                    {% if abnormal_values %}
                                                        Kontrol Edilmeli
                                                    {% else %}
                                                        Genel Sağlık Durumu Normal
                                                    {% endif %}
                                                </div>
                                                <div class="small">
                                                    {% if abnormal_values %}
                                                        {{ abnormal_values|length }} parametre normal aralığın dışında
                                                    {% else %}
                                                        Tüm değerler referans aralıklarında
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if test_values|length > 0 %}
                                                {% set normal_percent = ((test_values|length - abnormal_values|length) / test_values|length * 100)|round %}
                                                <div class="ms-auto">
                                                    <span class="badge {% if normal_percent > 80 %}bg-success{% elif normal_percent > 60 %}bg-info{% elif normal_percent > 40 %}bg-warning{% else %}bg-danger{% endif %} rounded-pill px-2 py-1">
                                                        <strong>{{ normal_percent }}%</strong> Normal
                                                    </span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hızlı Sonuç Göstergeleri -->
                    <div class="row mb-4 g-3">
                        <div class="col-md-3 col-6">
                            <div class="card parameter-card bg-white h-100 text-center">
                                <div class="card-body p-3">
                                    <div class="parameter-icon mx-auto" style="background: linear-gradient(135deg, #FF6B6B, #FF8787);">
                                        <i class="fas fa-heartbeat"></i>
                                    </div>
                                    <h6 class="text-uppercase mt-3 mb-0 small fw-bold">Kalp Sağlığı</h6>
                                    {% if abnormal_values|selectattr('parameter_name', 'search', 'Kolesterol')|list or 
                                          abnormal_values|selectattr('parameter_name', 'search', 'HDL')|list or 
                                          abnormal_values|selectattr('parameter_name', 'search', 'LDL')|list or 
                                          abnormal_values|selectattr('parameter_name', 'search', 'Trigliserit')|list %}
                                        <span class="badge bg-warning-subtle text-warning-emphasis d-block mt-2">Kontrol Edilmeli</span>
                                    {% else %}
                                        <span class="badge bg-success-subtle text-success-emphasis d-block mt-2">Normal</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 col-6">
                            <div class="card parameter-card bg-white h-100 text-center">
                                <div class="card-body p-3">
                                    <div class="parameter-icon mx-auto" style="background: linear-gradient(135deg, #4DABF7, #228BE6);">
                                        <i class="fas fa-tint"></i>
                                    </div>
                                    <h6 class="text-uppercase mt-3 mb-0 small fw-bold">Hematoloji</h6>
                                    {% if abnormal_values|selectattr('parameter_name', 'search', 'Hemoglobin')|list or 
                                          abnormal_values|selectattr('parameter_name', 'search', 'Eritrosit')|list or 
                                          abnormal_values|selectattr('parameter_name', 'search', 'Lökosit')|list %}
                                        <span class="badge bg-warning-subtle text-warning-emphasis d-block mt-2">Kontrol Edilmeli</span>
                                    {% else %}
                                        <span class="badge bg-success-subtle text-success-emphasis d-block mt-2">Normal</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 col-6">
                            <div class="card parameter-card bg-white h-100 text-center">
                                <div class="card-body p-3">
                                    <div class="parameter-icon mx-auto" style="background: linear-gradient(135deg, #82C91E, #5C940D);">
                                        <i class="fas fa-apple-alt"></i>
                                    </div>
                                    <h6 class="text-uppercase mt-3 mb-0 small fw-bold">Metabolizma</h6>
                                    {% if abnormal_values|selectattr('parameter_name', 'search', 'Glukoz')|list or 
                                          abnormal_values|selectattr('parameter_name', 'search', 'HbA1c')|list or 
                                          abnormal_values|selectattr('parameter_name', 'search', 'İnsülin')|list %}
                                        <span class="badge bg-warning-subtle text-warning-emphasis d-block mt-2">Kontrol Edilmeli</span>
                                    {% else %}
                                        <span class="badge bg-success-subtle text-success-emphasis d-block mt-2">Normal</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 col-6">
                            <div class="card parameter-card bg-white h-100 text-center">
                                <div class="card-body p-3">
                                    <div class="parameter-icon mx-auto" style="background: linear-gradient(135deg, #BE4BDB, #9C36B5);">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <h6 class="text-uppercase mt-3 mb-0 small fw-bold">Bağışıklık</h6>
                                    {% if abnormal_values|selectattr('parameter_name', 'search', 'Lenfosit')|list or 
                                          abnormal_values|selectattr('parameter_name', 'search', 'CRP')|list or 
                                          abnormal_values|selectattr('parameter_name', 'search', 'Sedim')|list %}
                                        <span class="badge bg-warning-subtle text-warning-emphasis d-block mt-2">Kontrol Edilmeli</span>
                                    {% else %}
                                        <span class="badge bg-success-subtle text-success-emphasis d-block mt-2">Normal</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tahlil Değerleri Tablosu -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                <i class="fas fa-table"></i>
                            </div>
                            <h5 class="mb-0">Tahlil Özeti</h5>
                        </div>
                        
                        <!-- Anormal Değerler Özeti -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12">
                    {% if abnormal_values %}
                                        <div class="alert alert-warning mb-3">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                            <div>
                                <h5 class="alert-heading">Dikkat Edilmesi Gereken Değerler</h5>
                                                    <p>Aşağıdaki değerler normal referans aralığının dışındadır:</p>
                                <ul class="mt-2 mb-0">
                                    {% for value in abnormal_values %}
                                    <li>
                                                            <strong>{{ value.parameter_name }}</strong>
                                                            {% if value.description %}
                                                            <div class="small">{{ value.description }}</div>
                                                            {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                                        {% else %}
                                        <div class="alert alert-success mb-0">
                                            <div class="d-flex">
                                                <div class="me-3">
                                                    <i class="fas fa-check-circle fa-2x"></i>
                                                </div>
                                                <div>
                                                    <h5 class="alert-heading">Tüm Değerler Normal Aralıkta</h5>
                                                    <p class="mb-0">Yapılan değerlendirmeye göre kan tahlili değerleri normal referans aralıklarında bulunmaktadır.</p>
                                                </div>
                                            </div>
                                        </div>
                    {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GENEL DEĞERLENDİRME ve NORMAL DIŞI DEĞERLER bölümleri için güncellemeler -->
                    <div class="row mb-4 g-3">
                        <div class="col-md-6">
                            <div class="card h-100 parameter-card bg-light">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-start mb-2">
                                        <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width:36px; height:36px;">
                                            <i class="fas fa-clipboard-check"></i>
                                        </div>
                                        <h6 class="card-title mb-1 fw-semibold">GENEL DEĞERLENDİRME</h6>
                                        {% if abnormal_values %}
                                        <span class="badge bg-warning-subtle text-warning-emphasis ms-auto rounded-pill px-2 py-1">
                                            <i class="fas fa-exclamation-circle me-1"></i>Dikkat
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success-subtle text-success-emphasis ms-auto rounded-pill px-2 py-1">
                                            <i class="fas fa-check-circle me-1"></i>Normal
                                        </span>
                                        {% endif %}
                                    </div>
                                    <p class="mb-0 small">
                                        {% if abnormal_values %}
                                        Tahlil sonuçlarınızda bazı değerler referans aralıklarının dışındadır. Bu durum sağlık durumunuzu değerlendirmek için bir sağlık uzmanına danışmanızı gerektirebilir.
                                        {% else %}
                                        Tahlil sonuçlarınız genel olarak normal aralıklarda görünmektedir. Sağlığınızı korumak için düzenli kontrollere devam etmeniz önerilir.
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100 parameter-card bg-light">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-start mb-2">
                                        <div class="bg-info bg-opacity-10 text-info rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width:36px; height:36px;">
                                            <i class="fas fa-filter"></i>
                                        </div>
                                        <h6 class="card-title mb-1 fw-semibold">NORMAL DIŞI DEĞERLER</h6>
                                        {% if abnormal_values %}
                                        <span class="badge bg-danger-subtle text-danger-emphasis ms-auto rounded-pill px-2 py-1">
                                            <i class="fas fa-exclamation-triangle me-1"></i>{{ abnormal_values|length }} değer
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success-subtle text-success-emphasis ms-auto rounded-pill px-2 py-1">
                                            <i class="fas fa-check-circle me-1"></i>0 değer
                                        </span>
                                        {% endif %}
                                    </div>
                                    <p class="mb-0 small">
                                        {% if abnormal_values %}
                                        Tespit edilen normal dışı değerler: 
                                        {% for value in abnormal_values[:3] %}
                                            <span class="badge {% if 'yüksek' in value.description|lower %}bg-danger-subtle text-danger-emphasis{% else %}bg-warning-subtle text-warning-emphasis{% endif %} me-1">{{ value.parameter_name }}</span>
                                        {% endfor %}
                                        {% if abnormal_values|length > 3 %}
                                            <span class="badge bg-secondary-subtle text-secondary-emphasis">+{{ abnormal_values|length - 3 }} daha</span>
                                        {% endif %}
                                        {% else %}
                                        Tahlil sonuçlarınızda normal dışı değer tespit edilmemiştir. Bu sonuçlar genel sağlık durumunuzun iyi olduğunu gösterir.
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Yapay Zeka Yorumu -->
                    <div class="mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white py-3 d-flex align-items-center">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <h5 class="mb-0">Yapay Zeka Yorumu</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="analysis-result">
                                    {% if analysis.analysis_result %}
                                        {% if analysis_json and analysis_json.summary %}
                                        <div class="mb-4 p-3 bg-primary-subtle border border-primary-subtle rounded">
                                            <h6 class="fw-bold text-primary mb-2"><i class="fas fa-comment-dots me-2"></i>Genel Değerlendirme</h6>
                                            <p class="mb-0 small">{{ analysis_json.summary }}</p>
                                        </div>
                                        {% else %}
                                        <div class="mb-4 p-3 bg-light border rounded">
                                            <h6 class="fw-bold text-primary mb-2"><i class="fas fa-comment-dots me-2"></i>Genel Değerlendirme</h6>
                                            <p class="mb-0 small">Tahlil sonuçlarınız genel olarak incelenmiştir. Sonuçlarınızın önemli bir kısmı normal aralıkta görünmektedir. Anormal değerlerinizi takip etmeniz ve düzenli sağlık kontrollerinizi sürdürmeniz önerilir.</p>
                                        </div>
                                        {% endif %}
                                        
                                        {% if abnormal_values %}
                                        <div class="alert alert-warning mb-4">
                                            <div class="d-flex">
                                                <div class="me-3"><i class="fas fa-exclamation-triangle fa-2x"></i></div>
                                                <div>
                                                    <h6 class="alert-heading fw-semibold">Referans Dışı Değerler</h6>
                                                    <p class="mb-1 small">Aşağıdaki parametreler referans aralıklarının dışındadır ve yapay zeka analizinde dikkate alınmıştır:</p>
                                                    <ul class="list-unstyled mb-0 small">
                                                    {% for value in abnormal_values %}
                                                        <li><i class="fas fa-caret-right me-1 text-warning"></i><strong>{{ value.parameter_name }}</strong>: {{ value.value }} {{ value.unit }} (Referans: {{ value.reference_range }})</li>
                                                    {% endfor %}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- DETAYLI PARAMETRE ANALİZİ (Tahlil Analizi - cards with gauges) -->
                                        <div class="mb-4">
                                            <h6 class="fw-bold text-primary mb-3"><i class="fas fa-microscope me-2"></i>Detaylı Parametre Analizi</h6>
                                            
                                            <!-- Genel Değerlendirme ve Normal Dışı Değerler -->
                                            <div class="row mb-4 g-3">
                                                <!-- GENEL DEĞERLENDİRME kartı -->
                                                <div class="col-md-6">
                                                    <div class="card h-100 parameter-card {% if abnormal_values %}bg-warning-subtle{% else %}bg-success-subtle{% endif %}">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex align-items-start mb-2">
                                                                <div class="parameter-icon bg-primary" style="width:40px; height:40px; margin-bottom:0; margin-right:12px;">
                                                                    <i class="fas fa-clipboard-check"></i>
                                                                </div>
                                                                <div>
                                                                    <h6 class="card-title mb-1 fw-semibold">GENEL DEĞERLENDİRME</h6>
                                                                    <p class="mb-0 small">
                                                                        {% if abnormal_values %}
                                                                        Tahlil sonuçlarınızda bazı değerler referans aralıklarının dışındadır. Bu durum çeşitli sağlık sorunlarına işaret edebilir. Detaylı değerlendirme için mutlaka bir hekime başvurunuz.
                                                                        {% else %}
                                                                        Tahlil sonuçlarınız genel olarak normal aralıklarda görünmektedir. Sağlığınızı korumak için düzenli kontrollere devam etmeniz önerilir.
                                                                        {% endif %}
                                                                    </p>
                                                                </div>
                                                                <span class="badge {% if abnormal_values %}bg-warning-subtle text-warning-emphasis{% else %}bg-success-subtle text-success-emphasis{% endif %} ms-auto rounded-pill px-2 py-1">
                                                                    {% if abnormal_values %}
                                                                    <i class="fas fa-exclamation-circle me-1"></i>Dikkat
                                                                    {% else %}
                                                                    <i class="fas fa-check-circle me-1"></i>Normal
                                                                    {% endif %}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- DEĞERLERİN GRUPLANDIRILMASI kartı -->
                                                <div class="col-md-6">
                                                    <div class="card h-100 parameter-card bg-light">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex align-items-start mb-2">
                                                                <div class="parameter-icon bg-success" style="width:40px; height:40px; margin-bottom:0; margin-right:12px;">
                                                                    <i class="fas fa-layer-group"></i>
                                                                </div>
                                                                <div>
                                                                    <h6 class="card-title mb-1 fw-semibold">DEĞERLERİN GRUPLANDIRILMASI</h6>
                                                                    <p class="mb-0 small">
                                                                        Kan değerleriniz sistem tarafından kategorize edilmiştir. Hematoloji, biyokimya, lipid ve diğer gruplar olarak sınıflandırılmıştır. Bu gruplama, sağlık durumunuzun farklı yönlerini değerlendirmeye yardımcı olur.
                                                                    </p>
                                                                </div>
                                                                <span class="badge bg-success-subtle text-success-emphasis ms-auto rounded-pill px-2 py-1">
                                                                    <i class="fas fa-check-circle me-1"></i>Normal
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- NORMAL DIŞI DEĞERLER kartı -->
                                                <div class="col-md-6">
                                                    <div class="card h-100 parameter-card {% if abnormal_values %}bg-danger-subtle{% else %}bg-success-subtle{% endif %}">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex align-items-start mb-2">
                                                                <div class="parameter-icon {% if abnormal_values %}bg-danger{% else %}bg-success{% endif %}" style="width:40px; height:40px; margin-bottom:0; margin-right:12px;">
                                                                    <i class="fas fa-filter"></i>
                                                                </div>
                                                                <div>
                                                                    <h6 class="card-title mb-1 fw-semibold">NORMAL DIŞI DEĞERLER</h6>
                                                                    <p class="mb-0 small">
                                                                        {% if abnormal_values %}
                                                                        Tahlil sonuçlarınızda {{ abnormal_values|length }} adet normal dışı değer tespit edilmiştir. Bu değerler çeşitli sağlık sorunlarını işaret edebilir. Detaylı değerlendirme için bir sağlık uzmanına danışmalısınız.
                                                                        {% else %}
                                                                        Tahlil sonuçlarınızda normal dışı değer tespit edilmemiştir. Bu durum genel sağlık durumunuzun iyi olduğunu gösterir. Düzenli kontrollere devam etmeniz önerilir.
                                                                        {% endif %}
                                                                    </p>
                                                                </div>
                                                                <span class="badge {% if abnormal_values %}bg-danger-subtle text-danger-emphasis{% else %}bg-success-subtle text-success-emphasis{% endif %} ms-auto rounded-pill px-2 py-1">
                                                                    {% if abnormal_values %}
                                                                    <i class="fas fa-exclamation-triangle me-1"></i>{{ abnormal_values|length }}
                                                                    {% else %}
                                                                    <i class="fas fa-check-circle me-1"></i>0
                                                                    {% endif %}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- TAM KAN SAYIMI kartı -->
                                                <div class="col-md-6">
                                                    <div class="card h-100 parameter-card bg-info-subtle">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex align-items-start mb-2">
                                                                <div class="parameter-icon bg-info" style="width:40px; height:40px; margin-bottom:0; margin-right:12px;">
                                                                    <i class="fas fa-tint"></i>
                                                                </div>
                                                                <div>
                                                                    <h6 class="card-title mb-1 fw-semibold">TAM KAN SAYIMI (HEMOGRAM)</h6>
                                                                    <p class="mb-0 small">
                                                                        Kan hücrelerinizin sayıları ve özellikleri incelenmiştir. Bu analiz kırmızı kan hücreleri, beyaz kan hücreleri ve trombositleri değerlendirir. Anemi, enfeksiyon veya kanama bozuklukları hakkında bilgi verir.
                                                                    </p>
                                                                </div>
                                                                <span class="badge bg-info-subtle text-info-emphasis ms-auto rounded-pill px-2 py-1">
                                                                    <i class="fas fa-info-circle me-1"></i>Bilgi
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- BİYOKİMYA kartı -->
                                                <div class="col-md-6">
                                                    <div class="card h-100 parameter-card bg-success-subtle">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex align-items-start mb-2">
                                                                <div class="parameter-icon bg-success" style="width:40px; height:40px; margin-bottom:0; margin-right:12px;">
                                                                    <i class="fas fa-flask"></i>
                                                                </div>
                                                                <div>
                                                                    <h6 class="card-title mb-1 fw-semibold">BİYOKİMYA (KAN)</h6>
                                                                    <p class="mb-0 small">
                                                                        Kan biyokimya parametreleri, vücudunuzdaki organ fonksiyonlarını değerlendirir. Böbrek ve karaciğer fonksiyonları, elektrolit dengesi ve metabolik durumunuz hakkında önemli bilgiler sağlar.
                                                                    </p>
                                                                </div>
                                                                <span class="badge bg-success-subtle text-success-emphasis ms-auto rounded-pill px-2 py-1">
                                                                    <i class="fas fa-check-circle me-1"></i>Normal
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- TAM İDRAR ANALİZİ kartı -->
                                                <div class="col-md-6">
                                                    <div class="card h-100 parameter-card bg-warning-subtle">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex align-items-start mb-2">
                                                                <div class="parameter-icon bg-warning" style="width:40px; height:40px; margin-bottom:0; margin-right:12px;">
                                                                    <i class="fas fa-vial"></i>
                                                                </div>
                                                                <div>
                                                                    <h6 class="card-title mb-1 fw-semibold">TAM İDRAR ANALİZİ</h6>
                                                                    <p class="mb-0 small">
                                                                        İdrar analizi, böbrek fonksiyonları ve genel sağlık durumu hakkında değerli bilgiler sağlar. İdrarda protein, kan, lökosit varlığı ve diğer parametreler incelenir. İdrar yolu enfeksiyonu veya böbrek hastalıkları hakkında ipuçları verebilir.
                                                                    </p>
                                                                </div>
                                                                <span class="badge bg-warning-subtle text-warning-emphasis ms-auto rounded-pill px-2 py-1">
                                                                    <i class="fas fa-sync-alt me-1"></i>Kontrol
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- İDRAR KÜLTÜRÜ kartı -->
                                                <div class="col-md-6">
                                                    <div class="card h-100 parameter-card bg-primary-subtle">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex align-items-start mb-2">
                                                                <div class="parameter-icon bg-primary" style="width:40px; height:40px; margin-bottom:0; margin-right:12px;">
                                                                    <i class="fas fa-bacteria"></i>
                                                                </div>
                                                                <div>
                                                                    <h6 class="card-title mb-1 fw-semibold">İDRAR KÜLTÜRÜ</h6>
                                                                    <p class="mb-0 small">
                                                                        İdrar kültürü, idrar yolu enfeksiyonlarının tanısında kullanılır. İdrarda bakteri üremesi olup olmadığını kontrol eder. İdrar yolu enfeksiyonlarının teşhisi ve tedavi planlaması için önemli bir testtir.
                                                                    </p>
                                                                </div>
                                                                <span class="badge bg-primary-subtle text-primary-emphasis ms-auto rounded-pill px-2 py-1">
                                                                    <i class="fas fa-info-circle me-1"></i>Bilgi
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {% if analysis.analysis_result %}
                                                {% set lines = analysis.analysis_result.split('\n') %}
                                                <div class="row g-3">
                                                    {% for line in lines %}
                                                    {% if ':' in line %}
                                                    {% set parts = line.split(':', 1) %}
                                                    {% set param_name = parts[0]|trim %}
                                                    {% set value_section = parts[1]|trim if parts|length > 1 else '' %}
                                                    
                                                    {% set value_parts = value_section.split('(', 1) if '(' in value_section else [value_section, ''] %}
                                                    {% set value_text = value_parts[0]|trim %}
                                                    {% set interpretation_text = value_parts[1].replace(')', '')|trim if value_parts|length > 1 and value_parts[1] else '' %}
                                                    
                                                    <div class="col-md-6 col-lg-4">
                                                        <div class="card h-100 parameter-card shadow-sm">
                                                            {% set interpretation_lower = interpretation_text.lower() %}
                                                            {% set value_text_lower = value_text.lower() %}
                                                            {% if 'yüksek' in interpretation_lower or 'artmış' in interpretation_lower or 'yüksek' in value_text_lower %}
                                                                <div class="card-body d-flex flex-column p-3" style="border-top: 3px solid var(--danger-color);">
                                                            {% elif 'düşük' in interpretation_lower or 'azalmış' in interpretation_lower or 'düşük' in value_text_lower %}
                                                                <div class="card-body d-flex flex-column p-3" style="border-top: 3px solid var(--warning-color);">
                                                            {% else %}
                                                                <div class="card-body d-flex flex-column p-3" style="border-top: 3px solid var(--success-color);">
                                                            {% endif %}
                                                                <div class="d-flex justify-content-between align-items-start mb-1">
                                                                    <h6 class="card-title mb-0 fw-semibold" style="font-size: 0.9rem;">{{ param_name|replace("**", "") }}</h6>
                                                                    
                                                                    {% if 'yüksek' in interpretation_lower or 'artmış' in interpretation_lower or 'yüksek' in value_text_lower %}
                                                                        <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill px-2 py-1 small">
                                                                            <i class="fas fa-arrow-up me-1 rotate-icon"></i>Yüksek
                                                                        </span>
                                                                    {% elif 'düşük' in interpretation_lower or 'azalmış' in interpretation_lower or 'düşük' in value_text_lower %}
                                                                        <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-2 py-1 small">
                                                                            <i class="fas fa-arrow-down me-1 rotate-icon"></i>Düşük
                                                                        </span>
                                                                    {% elif 'normal' in interpretation_lower or value_text.strip() == '**' or value_text.strip() == '-' or 'normal' in value_text_lower %}
                                                                        <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-2 py-1 small">
                                                                            <i class="fas fa-check me-1"></i>Normal
                                                                        </span>
                                                                    {% else %}
                                                                        <!-- No badge if state is unclear -->
                                                                    {% endif %}
                                                                </div>
                                    
                                                                {% if value_text.strip() != '**' and value_text.strip() != '-' %}
                                                                    <div class="mt-auto">
                                                                        <div class="mb-2">
                                                                            <div class="small text-muted mb-1">
                                                                                <span class="fw-medium">Sonuç: </span><strong class="text-body">{{ value_text|replace("**", "") }}</strong>
                                                                            </div>
                                                                            <div class="value-gauge">
                                                                                {% if 'yüksek' in interpretation_lower or 'artmış' in interpretation_lower or 'yüksek' in value_text_lower %}
                                                                                    <div class="value-gauge-fill danger" style="width: 90%;"></div>
                                                                                {% elif 'düşük' in interpretation_lower or 'azalmış' in interpretation_lower or 'düşük' in value_text_lower %}
                                                                                    <div class="value-gauge-fill warning" style="width: 30%;"></div>
                                                                                {% else %}
                                                                                    <div class="value-gauge-fill normal" style="width: 60%;"></div>
                                                                                {% endif %}
                                                                            </div>
                                                                        </div>
                                                                        {% set ref_range_in_value = "" %}
                                                                        {% if "referans aralığı" in value_text %}
                                                                            {% set ref_range_parts = value_text.split("referans aralığı") %}
                                                                            {% if ref_range_parts|length > 1 %}
                                                                                {% set ref_part = ref_range_parts[1] %}
                                                                                {% set ref_parts = ref_part.split(".") %}
                                                                                {% if ref_parts|length > 0 %}
                                                                                    {% set ref_range_in_value = ref_parts[0]|trim %}
                                                                                {% endif %}
                                                                            {% endif %}
                                                                            {% if ref_range_in_value %}
                                                                            <div class="small text-muted">
                                                                                <i class="fas fa-ruler-horizontal me-1"></i>Referans: <span class="fw-medium">{{ ref_range_in_value }}</span>
                                                                            </div>
                                                                            {% endif %}
                                                                        {% endif %}
                                                                        
                                                                        {% if interpretation_text and ('yüksek' not in interpretation_text.lower() and 'düşük' not in interpretation_text.lower() and 'normal' not in interpretation_text.lower()) %}
                                                                        <div class="mt-2 small text-muted fst-italic">
                                                                            <i class="fas fa-info-circle text-primary me-1"></i>{{ interpretation_text }}
                                                                        </div>
                                                                        {% endif %}
                                                                    </div>
                                                                {% else %}
                                                                    <div class="mt-auto text-center text-muted small py-2">
                                                                        <p class="mb-1">
                                                                            {% if param_name == 'Tam İdrar Analizi' %}
                                                                            <em>İdrar analizi sonuçlarınız hakkında bilgi edinmek için laboratuvar raporunu inceleyiniz.</em>
                                                                            {% elif param_name == 'Hemoglobin' %}
                                                                            <em>Hemoglobin değeri, kanın oksijen taşıma kapasitesini gösterir.</em>
                                                                            {% elif param_name == 'Biyokimya' %}
                                                                            <em>Biyokimya testleri, vücudunuzdaki organ fonksiyonlarını değerlendirmek için kullanılır.</em>
                                                                            {% elif 'Sodyum' in param_name or 'Potasyum' in param_name %}
                                                                            <em>Elektrolit değerleri, vücudunuzdaki sıvı dengesinin korunmasında önemlidir.</em>
                                                                            {% elif 'Kreatinin' in param_name or 'Üre' in param_name %}
                                                                            <em>Böbrek fonksiyonlarının değerlendirilmesinde kullanılan önemli parametrelerdir.</em>
                                                                            {% elif 'Glukoz' in param_name or 'Şeker' in param_name %}
                                                                            <em>Kan şekeri düzeyi, metabolik sağlığınızın önemli bir göstergesidir.</em>
                                                                            {% elif 'Kolesterol' in param_name or 'Lipit' in param_name or 'HDL' in param_name or 'LDL' in param_name %}
                                                                            <em>Kan yağ değerleri, kalp-damar hastalık riskinizi gösterir.</em>
                                                                            {% elif 'Tiroid' in param_name or 'TSH' in param_name %}
                                                                            <em>Tiroid fonksiyonları, metabolizma hızınızı düzenlemede önemlidir.</em>
                                                                            {% else %}
                                                                            <em>Bu parametre hakkında detaylı bilgi için sağlık uzmanınıza danışınız.</em>
                                                                            {% endif %}
                                                                        </p>
                                                                        <div class="value-gauge">
                                                                             <div class="value-gauge-fill" style="width: 50%; background-color: #e9ecef;"></div>
                                                                        </div>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    {% endfor %}
                                                </div>
                                                
                                                <div class="alert alert-light mt-3 mb-0 small border">
                                                    <h6 class="alert-heading small fw-semibold mb-1">Değer Gösterge Renkleri</h6>
                                                    <div class="d-flex flex-wrap gap-3">
                                                        <span><i class="fas fa-circle text-success me-1"></i>Normal</span>
                                                        <span><i class="fas fa-circle text-warning me-1"></i>Düşük</span>
                                                        <span><i class="fas fa-circle text-danger me-1"></i>Yüksek</span>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="alert alert-secondary">Tahlil analizi sonuçları yüklenemedi.</div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- OLASI HASTALIK TAHMİNLERİ -->
                                        {% if analysis_json and analysis_json.health_conditions is defined %}
                                        <div class="mb-4">
                                            <h6 class="fw-bold text-primary mb-3"><i class="fas fa-stethoscope me-2"></i>Olası Hastalık Tahminleri</h6>
                                            <div class="alert alert-warning d-flex align-items-center small mb-3 p-2">
                                                <i class="fas fa-exclamation-triangle fa-lg me-2"></i>
                                                <div><strong>Önemli Not:</strong> Bu bölümdeki tahminler, sadece tahlil değerlerinize dayanmaktadır ve kesin tanı niteliği taşımaz. Mutlaka bir sağlık uzmanına danışınız.</div>
                                            </div>
                                            {% if analysis_json.health_conditions %}
                                            <div class="row g-3">
                                                {% for condition in analysis_json.health_conditions %}
                                                <div class="col-md-6">
                                                    <div class="card h-100 shadow-sm border-light">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex align-items-start mb-2">
                                                                <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width:36px; height:36px; font-size:0.9rem;">
                                                                    <i class="fas fa-notes-medical"></i>
                                                                </div>
                                                                <h6 class="card-title mb-1 fw-semibold small">{{ condition.name }}</h6>
                                                            </div>
                                                            <p class="mb-2 text-muted" style="font-size: 0.85rem;">{{ condition.description }}</p>
                                                            {% if condition.related_values %}
                                                            <div class="mt-2">
                                                                <small class="text-muted fw-medium" style="font-size: 0.8rem;">İlgili Değerler:</small>
                                                                <div>
                                                                {% for value_item in condition.related_values.split(',') %}
                                                                    <span class="badge bg-info-subtle text-info-emphasis me-1 mb-1 small">{{ value_item|trim }}</span>
                                                                {% endfor %}
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Tahlil değerlerinize göre belirli bir hastalık tahmini yapılamamıştır.
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% else %}
                                        <!-- OLASI SAĞLIK DURUMLARI - Varsayılan görünüm -->
                                        <div class="mb-4">
                                            <h6 class="fw-bold text-primary mb-3"><i class="fas fa-stethoscope me-2"></i>Olası Sağlık Durumları</h6>
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="card h-100 shadow-sm border-light">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex align-items-start mb-2">
                                                                <div class="bg-success bg-opacity-10 text-success rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width:36px; height:36px; font-size:0.9rem;">
                                                                    <i class="fas fa-heartbeat"></i>
                                                                </div>
                                                                <h6 class="card-title mb-1 fw-semibold small">Genel Sağlık Değerlendirmesi</h6>
                                                            </div>
                                                            <p class="mb-2 text-muted" style="font-size: 0.85rem;">Tahlil sonuçlarınız genel olarak normal aralıkta görünmektedir. Olası sağlık durumları için yapay zeka analizi yapılamamıştır. Sonuçlarınızı bir sağlık uzmanıyla detaylı olarak değerlendirmenizi öneririz.</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6">
                                                    <div class="card h-100 shadow-sm border-light">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex align-items-start mb-2">
                                                                <div class="bg-info bg-opacity-10 text-info rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width:36px; height:36px; font-size:0.9rem;">
                                                                    <i class="fas fa-calendar-check"></i>
                                                                </div>
                                                                <h6 class="card-title mb-1 fw-semibold small">Önleyici Sağlık Tavsiyeleri</h6>
                                                            </div>
                                                            <p class="mb-2 text-muted" style="font-size: 0.85rem;">Düzenli sağlık kontrollerini sürdürmek, dengeli beslenme ve düzenli fiziksel aktivite, çoğu hastalığın önlenmesinde önemli rol oynar. Yılda bir kez genel sağlık kontrolü yaptırmanız önerilir.</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- SAĞLIK VE YAŞAM TARZI ÖNERİLERİ -->
                                        {% if (analysis_json and analysis_json.recommendations) or (analysis_json and analysis_json.lifestyle_advice) %}
                                        <div class="mb-0">
                                            <h6 class="fw-bold text-primary mb-3"><i class="fas fa-heartbeat me-2"></i>Sağlık ve Yaşam Tarzı Önerileri</h6>
                                            <div class="row g-3">
                                                {% if analysis_json.recommendations %}
                                                    {% for advice in analysis_json.recommendations %}
                                                    <div class="col-md-6">
                                                        <div class="card h-100 shadow-sm border-light">
                                                            <div class="card-body d-flex align-items-start p-3">
                                                                <div class="bg-success-subtle text-success-emphasis rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width:36px; height:36px; font-size:0.9rem;">
                                                                    <i class="fas fa-check"></i>
                                                                </div>
                                                                <p class="mb-0" style="font-size: 0.85rem;">{{ advice }}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                {% endif %}
                                                {% if analysis_json.lifestyle_advice %}
                                                    {% for advice in analysis_json.lifestyle_advice %}
                                                    <div class="col-md-6">
                                                        <div class="card h-100 shadow-sm border-light">
                                                            <div class="card-body d-flex align-items-start p-3">
                                                                <div class="bg-warning-subtle text-warning-emphasis rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width:36px; height:36px; font-size:0.9rem;">
                                                                    <i class="fas fa-leaf"></i>
                                                                </div>
                                                                <p class="mb-0" style="font-size: 0.85rem;">{{ advice }}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}

                                    {% else %}
                                        <div class="alert alert-danger mb-3 d-flex align-items-center">
                                            <i class="fas fa-exclamation-circle me-2"></i>
                                            <div>Tahlil sonucu yüklenirken bir hata oluştu. Lütfen yeni bir tahlil yüklemeyi deneyin.</div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Öneriler -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <h5 class="mb-0">Sağlık Önerileri</h5>
                        </div>
                        
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-4">
                                {% if analysis_json and analysis_json.recommendations %}
                                <div class="mb-3">
                                    <div class="row">
                                        {% for recommendation in analysis_json.recommendations %}
                                        <div class="col-md-6 mb-3">
                                            <div class="d-flex">
                                                <div class="flex-shrink-0 me-3 text-warning">
                                                    <i class="fas fa-check-circle fa-lg"></i>
                                                </div>
                                                <div>
                                                    <p class="mb-0">{{ recommendation }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% else %}
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item border-0 ps-0">
                                        <div class="d-flex">
                                            <div class="me-3 text-primary">
                                                <i class="fas fa-heartbeat fa-lg"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0">Düzenli sağlık kontrollerinizi sürdürün ve tahlil sonuçlarınızı doktorunuzla değerlendirin.</p>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="list-group-item border-0 ps-0">
                                        <div class="d-flex">
                                            <div class="me-3 text-success">
                                                <i class="fas fa-apple-alt fa-lg"></i> 
                                            </div>
                                            <div>
                                                <p class="mb-0">Dengeli ve sağlıklı beslenmeye özen gösterin. Sebze, meyve ve tam tahılları diyetinize dahil edin.</p>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="list-group-item border-0 ps-0">
                                        <div class="d-flex">
                                            <div class="me-3 text-danger">
                                                <i class="fas fa-walking fa-lg"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0">Düzenli egzersiz yapın. Haftada en az 150 dakika orta yoğunlukta fiziksel aktivite önerilmektedir.</p>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="list-group-item border-0 ps-0">
                                        <div class="d-flex">
                                            <div class="me-3 text-info">
                                                <i class="fas fa-glass-water fa-lg"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0">Günlük su tüketiminize dikkat edin. Yetişkinler için günde ortalama 2-2.5 litre su içilmesi önerilir.</p>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                                {% endif %}
                                
                                <div class="alert alert-warning mt-3 mb-0 d-flex align-items-center small">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <div>Bu öneriler, tahlil sonuçlarınızın yapay zeka analizine dayanmaktadır. Sağlık durumunuz hakkında kesin bilgi için mutlaka bir sağlık uzmanına danışmalısınız.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Uyarı -->
                    <div class="alert alert-warning d-flex" role="alert">
                        <div class="me-3">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                        <div>
                            <h5 class="alert-heading">Önemli Uyarı</h5>
                            <p class="mb-0">Bu analiz sadece bilgilendirme amaçlıdır ve profesyonel tıbbi tavsiye yerine geçmez. Sağlık durumunuz hakkında endişeleriniz varsa, lütfen bir sağlık uzmanına danışın.</p>
                        </div>
                    </div>
                    
                    <!-- Tahlil İçeriği -->
                    <div class="accordion mt-4" id="tahlilAccordion">
                        <div class="accordion-item border-0 shadow-sm">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                    <i class="fas fa-file-medical me-2"></i> Tahlil İçeriği (İlk 1000 karakter)
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#tahlilAccordion">
                                <div class="accordion-body bg-light">
                                    <pre class="mb-0 text-muted small" style="white-space: pre-wrap; word-break: break-all;">{{ analysis.analysis_text }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer Actions -->
                <div class="card-footer bg-white py-3 d-flex justify-content-between">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Panele Dön
                    </a>
                    <div>
                        <button class="btn btn-outline-primary me-2 btn-print" onclick="window.print()">
                            <i class="fas fa-print me-1"></i>Yazdır
                        </button>
                        <a href="{{ url_for('analyze') }}" class="btn btn-primary">
                            <i class="fas fa-file-upload me-1"></i>Yeni Tahlil Yükle
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Paylaşım Seçenekleri -->
            <div class="d-flex justify-content-center mt-4">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-envelope me-1"></i>E-posta ile Gönder
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-file-pdf me-1"></i>PDF Olarak İndir
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-share-alt me-1"></i>Paylaş
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Print fonksiyonu için sayfa düzeni ayarlamaları
    document.querySelector('.btn-print').addEventListener('click', function() {
        window.print();
    });
    
    // Tahlil içeriğini biçimlendir
    const tahlilContent = document.querySelector('.tahlil-content');
    if (tahlilContent) {
        // Başlıkları vurgula
        const textContent = tahlilContent.innerHTML;
        let formattedContent = textContent;
        
        // Başlıkları belirleyip biçimlendir
        const headerRegex = /([A-ZĞÜŞİÖÇIğüşıöçi]+:)/g;
        formattedContent = formattedContent.replace(headerRegex, '<strong class="text-primary">$1</strong>');
        
        // Normal ve anormal değerleri vurgula
        formattedContent = formattedContent.replace(/(normal değil|yüksek|düşük|anormal)/gi, '<span class="text-danger fw-bold">$1</span>');
        formattedContent = formattedContent.replace(/(normal aralıkta|normal sınırlar)/gi, '<span class="text-success">$1</span>');
        
        // İçeriği güncelle
        tahlilContent.innerHTML = formattedContent;
    }
    
    // Değer çubukları animasyonu
    const animateValueGauges = () => {
        const gauges = document.querySelectorAll('.value-gauge-fill');
        gauges.forEach(gauge => {
            const width = gauge.style.width;
            gauge.style.width = '0%';
            setTimeout(() => {
                gauge.style.width = width;
            }, 300);
        });
    };
    
    // Kart animasyonları
    const animateCards = () => {
        const cards = document.querySelectorAll('.card:not(.animated)');
        cards.forEach((card, index) => {
            card.classList.add('animated');
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    };
    
    // Parametre kartlarını izle ve görünür olduğunda animasyonu başlat
    const observeElements = () => {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    if (entry.target.classList.contains('value-gauge-fill')) {
                        entry.target.style.width = entry.target.getAttribute('data-width') || '0%';
                    } else if (entry.target.classList.contains('parameter-card')) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        
        document.querySelectorAll('.value-gauge-fill').forEach(gauge => {
            const width = gauge.style.width;
            gauge.setAttribute('data-width', width);
            gauge.style.width = '0%';
            observer.observe(gauge);
        });
        
        document.querySelectorAll('.parameter-card').forEach(card => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            observer.observe(card);
        });
    };
    
    // Tüm animasyonları başlat
    setTimeout(() => {
        animateValueGauges();
        animateCards();
        observeElements();
    }, 500);
    
    // Sayfa içi geçişler için yumuşak kaydırma
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });
    
    // Olası hastalık kartlarına hover efekti
    const hastalıkKartları = document.querySelectorAll('.card');
    hastalıkKartları.forEach(kart => {
        kart.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'transform 0.3s ease';
            this.style.boxShadow = 'var(--hover-shadow)';
        });
        
        kart.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'var(--card-shadow)';
        });
    });
    });
</script>
{% endblock %}