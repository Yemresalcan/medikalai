{% extends "layout.html" %}

{% block title %}Tahlil Sonucu - MediTahlil{% endblock %}

{% block extra_css %}
<!-- Chart.js kütüphanesi -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
<style>
    .analysis-result {
        line-height: 1.7;
        color: #333;
    }
    
    [data-bs-theme="dark"] .analysis-result {
        color: #ffffff;
    }
    
    .analysis-result strong {
        color: #0d6efd;
        font-weight: 600;
    }
    
    .tahlil-content {
        white-space: pre-line;
        font-size: 1.05rem;
    }
    
    /* Referans çubuğu stilleri */
    .value-bar {
        height: 25px;
        border-radius: 4px;
        position: relative;
        background-color: #e9ecef;
        margin: 8px 0;
    }
    
    [data-bs-theme="dark"] .value-bar {
        background-color: #343a40;
    }
    
    .ref-range {
        position: absolute;
        height: 100%;
        background-color: rgba(25, 135, 84, 0.15);
        z-index: 1;
    }
    
    .value-marker {
        position: absolute;
        width: 2px;
        height: 25px;
        background-color: #212529;
        z-index: 2;
    }
    
    [data-bs-theme="dark"] .value-marker {
        background-color: #ffffff;
    }
    
    .value-marker.normal {
        background-color: #198754; /* Yeşil */
    }
    
    .value-marker.abnormal {
        background-color: #dc3545; /* Kırmızı */
    }
    
    .value-marker::after {
        content: '';
        position: absolute;
        bottom: -6px;
        left: -4px;
        width: 10px;
        height: 10px;
        background-color: inherit;
        border-radius: 50%;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    [data-bs-theme="dark"] .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.15);
    }
    
    /* Kategori sekmesi stilleri */
    .nav-pills .nav-link.active {
        background-color: #0d6efd;
    }
    
    .tab-content {
        padding-top: 1rem;
    }
    
    /* Karanlık mod için tablo renkleri */
    [data-bs-theme="dark"] table {
        color: #ffffff;
    }
    
    [data-bs-theme="dark"] table thead th {
        color: #ffffff;
    }
    
    [data-bs-theme="dark"] table tbody td {
        color: #ffffff;
    }
    
    [data-bs-theme="dark"] .card-title,
    [data-bs-theme="dark"] .card-text,
    [data-bs-theme="dark"] .card-header h4,
    [data-bs-theme="dark"] .card-body h5,
    [data-bs-theme="dark"] .card-body h6,
    [data-bs-theme="dark"] .card-body p {
        color: #ffffff;
    }
    
    [data-bs-theme="dark"] .bg-light {
        background-color: #343a40 !important;
    }
    
    [data-bs-theme="dark"] .text-muted {
        color: #e0e0e0 !important;
    }
    
    [data-bs-theme="dark"] .bg-white {
        background-color: #2b3035 !important;
    }
    
    @media print {
        .navbar, .footer, .btn, .accordion, .alert, .card-footer, .nav-pills {
            display: none !important;
        }
        
        .tab-pane {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Baskı için tablonun tamamını göster */
        .tab-content > .tab-pane {
            display: block !important;
        }
    }
    
    /* Tavsiye kartları */
    .recommendation-card {
        transition: transform 0.3s ease;
    }
    
    .recommendation-card:hover {
        transform: translateY(-5px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-11">
            <!-- Üst Bilgi Kartı -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-file-medical-alt me-2 text-primary"></i>Tahlil Analiz Sonucu</h4>
                    <span class="badge bg-primary rounded-pill px-3 py-2">{{ analysis.created_at.split()[0] }}</span>
                </div>
                
                <!-- Analiz Bilgisi Kartı -->
                <div class="card-body p-4">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">Dosya Bilgileri</h5>
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="fas fa-file-pdf text-danger me-3" style="font-size: 2rem;"></i>
                                        <div>
                                            <h6 class="mb-0">{{ analysis.file_name }}</h6>
                                            <p class="text-muted mb-0 small">{{ analysis.created_at }}</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <span class="badge bg-primary me-2">Kan Tahlili</span>
                                        <span class="badge bg-secondary">{{ test_values|length }} Parametre</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-0 {% if abnormal_values %}bg-warning bg-opacity-10{% else %}bg-success bg-opacity-10{% endif %}">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">Özet Durum</h5>
                                    <div class="d-flex align-items-center mb-3">
                                        {% if abnormal_values %}
                                            <i class="fas fa-exclamation-triangle text-warning me-3" style="font-size: 2rem;"></i>
                                            <div>
                                                <h6 class="mb-0">Dikkat Gerektiren Değerler</h6>
                                                <p class="mb-0">{{ abnormal_values|length }} parametre normal aralığın dışında</p>
                                            </div>
                                        {% else %}
                                            <i class="fas fa-check-circle text-success me-3" style="font-size: 2rem;"></i>
                                            <div>
                                                <h6 class="mb-0">Normal Değerler</h6>
                                                <p class="mb-0">Tüm değerler referans aralıklarında</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="progress mt-3" style="height: 10px;">
                                        {% if test_values|length > 0 %}
                                            {% set normal_percent = ((test_values|length - abnormal_values|length) / test_values|length * 100)|round %}
                                        {% else %}
                                            {% set normal_percent = 0 %}
                                        {% endif %}
                                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ normal_percent }}%;" 
                                            aria-valuenow="{{ normal_percent }}" aria-valuemin="0" aria-valuemax="100">{{ normal_percent }}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Anormal Değerler Özeti (Eğer Varsa) -->
                    {% if abnormal_values %}
                    <div class="alert alert-warning mb-4">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                            <div>
                                <h5 class="alert-heading">Dikkat Edilmesi Gereken Değerler</h5>
                                <p class="mb-0">Aşağıdaki değerler normal referans aralığının dışındadır:</p>
                                <ul class="mt-2 mb-0">
                                    {% for value in abnormal_values %}
                                    <li>
                                        <strong>{{ value.parameter_name }}:</strong> {{ value.value }} {{ value.unit }} 
                                        (Referans: {{ value.ref_min }}-{{ value.ref_max }} {{ value.unit }})
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Yapay Zeka Yorumu -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                <i class="fas fa-robot"></i>
                            </div>
                            <h5 class="mb-0">Yapay Zeka Yorumu</h5>
                        </div>
                        
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <div class="analysis-result">
                                    {% if analysis_json and analysis_json.summary %}
                                        <div class="mb-4">
                                            <h6 class="fw-bold text-primary mb-2">Genel Değerlendirme</h6>
                                            <p>{{ analysis_json.summary }}</p>
                                        </div>
                                        
                                        {% if analysis_json.test_groups %}
                                        <div class="mt-4">
                                            <h6 class="fw-bold text-primary mb-2">Grup Analizi</h6>
                                            {% for group in analysis_json.test_groups %}
                                            <div class="mb-3">
                                                <h6 class="fw-bold">{{ group.group_name }}</h6>
                                                {% if group.group_description %}
                                                <p class="small text-muted mb-2">{{ group.group_description }}</p>
                                                {% endif %}
                                                <ul class="list-unstyled">
                                                    {% for param in group.parameters %}
                                                    <li class="mb-2">
                                                        <div class="d-flex align-items-center">
                                                            <span class="me-2 {% if not param.is_normal %}text-danger fw-bold{% endif %}">
                                                                {{ param.name }}: {{ param.value }} {{ param.unit }}
                                                                (Referans: {{ param.ref_min }} - {{ param.ref_max }} {{ param.unit }})
                                                            </span>
                                                            {% if param.is_normal %}
                                                            <span class="badge bg-success ms-1">Normal</span>
                                                            {% else %}
                                                            <span class="badge bg-danger ms-1">Normal Dışı</span>
                                                            {% endif %}
                                                        </div>
                                                        {% if param.comment %}
                                                        <small class="d-block mb-1">{{ param.comment }}</small>
                                                        {% endif %}
                                                        {% if param.explanation %}
                                                        <small class="text-muted d-block">{{ param.explanation }}</small>
                                                        {% endif %}
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        
                                        {% if analysis_json.possible_conditions %}
                                        <div class="mt-4">
                                            <h6 class="fw-bold text-primary mb-3">Olası Sağlık Durumları</h6>
                                            <div class="row">
                                                {% for condition in analysis_json.possible_conditions %}
                                                <div class="col-md-6 mb-3">
                                                    <div class="card border-0 {% if condition.likelihood == 'yüksek' %}border-start border-4 border-danger{% elif condition.likelihood == 'orta' %}border-start border-4 border-warning{% else %}border-start border-4 border-info{% endif %} shadow-sm">
                                                        <div class="card-body py-3">
                                                            <h6 class="card-title d-flex justify-content-between mb-2">
                                                                {{ condition.condition }}
                                                                <span class="badge {% if condition.likelihood == 'yüksek' %}bg-danger{% elif condition.likelihood == 'orta' %}bg-warning{% else %}bg-info{% endif %}">{{ condition.likelihood }} olasılık</span>
                                                            </h6>
                                                            <p class="card-text small mb-2">{{ condition.explanation }}</p>
                                                            {% if condition.related_parameters %}
                                                            <p class="card-text small text-muted">
                                                                İlgili parametreler: {{ condition.related_parameters|join(', ') }}
                                                            </p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <div class="alert alert-info mt-2 small">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Bu değerlendirmeler yalnızca tahlil sonuçlarına dayanmaktadır ve kesin tanı yerine geçmez. Kesin tanı için mutlaka doktorunuza danışın.
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if analysis_json.general_analysis %}
                                        <div class="mt-4">
                                            <h6 class="fw-bold text-primary mb-2">Detaylı Yorum</h6>
                                            <p>{{ analysis_json.general_analysis }}</p>
                                        </div>
                                        {% endif %}
                                        
                                        {% if analysis_json.doctor_consultation %}
                                        <div class="mt-4">
                                            <h6 class="fw-bold text-primary mb-2">Doktor Danışma Önerisi</h6>
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-body">
                                                    <div class="d-flex">
                                                        <div class="me-3 text-{% if analysis_json.doctor_consultation.urgency == 'acil' %}danger{% elif analysis_json.doctor_consultation.urgency == 'öncelikli' %}warning{% else %}primary{% endif %}">
                                                            <i class="fas fa-user-md fa-2x"></i>
                                                        </div>
                                                        <div>
                                                            {% if analysis_json.doctor_consultation.recommended %}
                                                            <p class="mb-2">Bu tahlil sonuçlarına göre bir doktor görüşü almanız önerilmektedir.</p>
                                                            {% if analysis_json.doctor_consultation.specialties %}
                                                            <p class="mb-2">Önerilen branşlar: <strong>{{ analysis_json.doctor_consultation.specialties|join(', ') }}</strong></p>
                                                            {% endif %}
                                                            <p class="mb-0 small">
                                                                <span class="badge bg-{% if analysis_json.doctor_consultation.urgency == 'acil' %}danger{% elif analysis_json.doctor_consultation.urgency == 'öncelikli' %}warning{% else %}primary{% endif %}">
                                                                    {{ analysis_json.doctor_consultation.urgency|capitalize }} seviye
                                                                </span>
                                                            </p>
                                                            {% else %}
                                                            <p class="mb-0">Bu tahlil sonuçlarına göre acil bir doktor görüşü gerekmemektedir. Ancak rutin sağlık kontrollerinizi sürdürmeniz önerilir.</p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if analysis_json.lifestyle_advice %}
                                        <div class="mt-4">
                                            <h6 class="fw-bold text-primary mb-3">Yaşam Tarzı Önerileri</h6>
                                            <div class="row">
                                                {% for advice in analysis_json.lifestyle_advice %}
                                                <div class="col-md-6 mb-3">
                                                    <div class="card border-0 shadow-sm h-100">
                                                        <div class="card-body">
                                                            <div class="d-flex">
                                                                <div class="me-3 text-success">
                                                                    <i class="fas fa-leaf fa-2x"></i>
                                                                </div>
                                                                <div>
                                                                    <p class="mb-0">{{ advice }}</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if analysis_json.additional_tests %}
                                        <div class="mt-4">
                                            <h6 class="fw-bold text-primary mb-3">Önerilen Ek Tetkikler</h6>
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-body">
                                                    <div class="d-flex">
                                                        <div class="me-3 text-info">
                                                            <i class="fas fa-flask fa-2x"></i>
                                                        </div>
                                                        <div>
                                                            <p class="mb-2">Bu tahlil sonuçlarına göre aşağıdaki ek tetkiklerin yapılması faydalı olabilir:</p>
                                                            <ul class="mb-0">
                                                                {% for test in analysis_json.additional_tests %}
                                                                <li>{{ test }}</li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% elif analysis.analysis_result %}
                                        {% set analysis_text = analysis.analysis_result|replace('\n\n', '<div class="my-3"></div>')|replace('\n', '<br>')|replace('**', '<strong>')|safe %}
                                        <div class="tahlil-content">
                                            {{ analysis_text }}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-danger mb-3 d-flex align-items-center">
                                            <i class="fas fa-exclamation-circle me-2"></i>
                                            <div>Tahlil sonucu yüklenirken bir hata oluştu. Lütfen yeni bir tahlil yüklemeyi deneyin.</div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tahlil Değerleri Tablosu -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                <i class="fas fa-table"></i>
                            </div>
                            <h5 class="mb-0">Tahlil Değerleri</h5>
                        </div>
                        
                        <!-- Kategori Sekmeleri -->
                        <ul class="nav nav-pills mb-3" id="valuesTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="all-tab" data-bs-toggle="pill" data-bs-target="#all-values" 
                                        type="button" role="tab" aria-controls="all-values" aria-selected="true">
                                    Tüm Değerler
                                </button>
                            </li>
                            {% for category_name in categories|sort %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="{{category_name|lower|replace(' ', '-')}}-tab" data-bs-toggle="pill" 
                                        data-bs-target="#{{category_name|lower|replace(' ', '-')}}-values" type="button" role="tab" 
                                        aria-controls="{{category_name|lower|replace(' ', '-')}}-values" aria-selected="false">
                                    {{category_name}}
                                </button>
                            </li>
                            {% endfor %}
                            {% if abnormal_values %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="abnormal-tab" data-bs-toggle="pill" data-bs-target="#abnormal-values" 
                                        type="button" role="tab" aria-controls="abnormal-values" aria-selected="false">
                                    <i class="fas fa-exclamation-triangle text-warning me-1"></i> Anormal Değerler
                                </button>
                            </li>
                            {% endif %}
                        </ul>
                        
                        <!-- Kategori İçerikleri -->
                        <div class="tab-content" id="valuesTabsContent">
                            <!-- Tüm Değerler -->
                            <div class="tab-pane fade show active" id="all-values" role="tabpanel" aria-labelledby="all-tab">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Parametre</th>
                                                <th>Değer</th>
                                                <th>Birim</th>
                                                <th>Referans Aralığı</th>
                                                <th>Durum</th>
                                                <th>Görselleştirme</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for value in test_values %}
                                            <tr>
                                                <td>
                                                    <strong>{{ value.parameter_name }}</strong>
                                                    <div class="small text-muted">{{ value.category }}</div>
                                                </td>
                                                <td class="{% if not value.is_normal %}text-danger fw-bold{% endif %}">{{ value.value }}</td>
                                                <td>{{ value.unit }}</td>
                                                <td>{{ value.ref_min }} - {{ value.ref_max }}</td>
                                                <td>
                                                    {% if value.is_normal %}
                                                    <span class="badge bg-success">Normal</span>
                                                    {% else %}
                                                    <span class="badge bg-danger">Normal Dışı</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="value-bar">
                                                        <div class="ref-range" 
                                                             style="left: 20%; right: 20%;">
                                                        </div>
                                                        <div class="value-marker {% if value.is_normal %}normal{% else %}abnormal{% endif %}"
                                                             style="left: {% if value.value is not none and value.ref_min is not none and value.ref_max is not none %}
                                                                       {% if value.value < value.ref_min %}
                                                                          10%
                                                                       {% elif value.value > value.ref_max %}
                                                                          90%
                                                                       {% else %}
                                                                          {{ ((value.value - value.ref_min) / (value.ref_max - value.ref_min) * 60 + 20)|round }}%
                                                                       {% endif %}
                                                                    {% else %}
                                                                       50%
                                                                    {% endif %};">
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Her Kategori İçin Ayrı Sekme -->
                            {% for category_name, values in categories.items() %}
                            <div class="tab-pane fade" id="{{category_name|lower|replace(' ', '-')}}-values" role="tabpanel"
                                 aria-labelledby="{{category_name|lower|replace(' ', '-')}}-tab">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Parametre</th>
                                                <th>Değer</th>
                                                <th>Birim</th>
                                                <th>Referans Aralığı</th>
                                                <th>Durum</th>
                                                <th>Görselleştirme</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for value in values %}
                                            <tr>
                                                <td>
                                                    <strong>{{ value.parameter_name }}</strong>
                                                    {% if value.description %}
                                                    <div class="small text-muted">{{ value.description }}</div>
                                                    {% endif %}
                                                </td>
                                                <td class="{% if not value.is_normal %}text-danger fw-bold{% endif %}">{{ value.value }}</td>
                                                <td>{{ value.unit }}</td>
                                                <td>{{ value.ref_min }} - {{ value.ref_max }}</td>
                                                <td>
                                                    {% if value.is_normal %}
                                                    <span class="badge bg-success">Normal</span>
                                                    {% else %}
                                                    <span class="badge bg-danger">Normal Dışı</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="value-bar">
                                                        <div class="ref-range" 
                                                             style="left: 20%; right: 20%;">
                                                        </div>
                                                        <div class="value-marker {% if value.is_normal %}normal{% else %}abnormal{% endif %}"
                                                             style="left: {% if value.value is not none and value.ref_min is not none and value.ref_max is not none %}
                                                                       {% if value.value < value.ref_min %}
                                                                          10%
                                                                       {% elif value.value > value.ref_max %}
                                                                          90%
                                                                       {% else %}
                                                                          {{ ((value.value - value.ref_min) / (value.ref_max - value.ref_min) * 60 + 20)|round }}%
                                                                       {% endif %}
                                                                    {% else %}
                                                                       50%
                                                                    {% endif %};">
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endfor %}
                            
                            <!-- Anormal Değerler Sekmesi -->
                            {% if abnormal_values %}
                            <div class="tab-pane fade" id="abnormal-values" role="tabpanel" aria-labelledby="abnormal-tab">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Parametre</th>
                                                <th>Değer</th>
                                                <th>Birim</th>
                                                <th>Referans Aralığı</th>
                                                <th>Sapma</th>
                                                <th>Görselleştirme</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for value in abnormal_values %}
                                            <tr>
                                                <td>
                                                    <strong>{{ value.parameter_name }}</strong>
                                                    <div class="small text-muted">{{ value.category }}</div>
                                                </td>
                                                <td class="text-danger fw-bold">{{ value.value }}</td>
                                                <td>{{ value.unit }}</td>
                                                <td>{{ value.ref_min }} - {{ value.ref_max }}</td>
                                                <td>
                                                    {% if value.value is not none and value.ref_min is not none and value.ref_max is not none %}
                                                        {% if value.value < value.ref_min %}
                                                        <span class="badge bg-info">Düşük</span>
                                                        {% elif value.value > value.ref_max %}
                                                        <span class="badge bg-danger">Yüksek</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge bg-secondary">Belirsiz</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="value-bar">
                                                        <div class="ref-range" 
                                                             style="left: 20%; right: 20%;">
                                                        </div>
                                                        <div class="value-marker abnormal"
                                                             style="left: {% if value.value is not none and value.ref_min is not none and value.ref_max is not none %}
                                                                       {% if value.value < value.ref_min %}
                                                                          10%
                                                                       {% elif value.value > value.ref_max %}
                                                                          90%
                                                                       {% else %}
                                                                          50%
                                                                       {% endif %}
                                                                    {% else %}
                                                                       50%
                                                                    {% endif %};">
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Geçmiş Karşılaştırma (Eğer veri varsa) -->
                    {% if comparison_data and comparison_data|length > 0 %}
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h5 class="mb-0">Geçmiş Tahlillerle Karşılaştırma</h5>
                        </div>
                        
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="row">
                                    <!-- Parametre seçimi -->
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label for="param-select" class="form-label">Parametre Seçin</label>
                                            <select class="form-select" id="param-select">
                                                {% for param_name, history in comparison_data.items() %}
                                                {% if history|length > 0 %}
                                                <option value="{{ param_name }}">{{ param_name }}</option>
                                                {% endif %}
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Grafik alanı -->
                                    <div class="col-md-9">
                                        <div class="chart-container" style="position: relative; height:250px;">
                                            <canvas id="trendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Öneriler -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <h5 class="mb-0">Sağlık Önerileri</h5>
                        </div>
                        
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-4">
                                {% if analysis_json and analysis_json.recommendations %}
                                <div class="mb-3">
                                    <div class="row">
                                        {% for recommendation in analysis_json.recommendations %}
                                        <div class="col-md-6 mb-3">
                                            <div class="d-flex">
                                                <div class="flex-shrink-0 me-3 text-warning">
                                                    <i class="fas fa-check-circle fa-lg"></i>
                                                </div>
                                                <div>
                                                    <p class="mb-0">{{ recommendation }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% else %}
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item border-0 ps-0">
                                        <div class="d-flex">
                                            <div class="me-3 text-primary">
                                                <i class="fas fa-heartbeat fa-lg"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0">Düzenli sağlık kontrollerinizi sürdürün ve tahlil sonuçlarınızı doktorunuzla değerlendirin.</p>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="list-group-item border-0 ps-0">
                                        <div class="d-flex">
                                            <div class="me-3 text-success">
                                                <i class="fas fa-apple-alt fa-lg"></i> 
                                            </div>
                                            <div>
                                                <p class="mb-0">Dengeli ve sağlıklı beslenmeye özen gösterin. Sebze, meyve ve tam tahılları diyetinize dahil edin.</p>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="list-group-item border-0 ps-0">
                                        <div class="d-flex">
                                            <div class="me-3 text-danger">
                                                <i class="fas fa-walking fa-lg"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0">Düzenli egzersiz yapın. Haftada en az 150 dakika orta yoğunlukta fiziksel aktivite önerilmektedir.</p>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="list-group-item border-0 ps-0">
                                        <div class="d-flex">
                                            <div class="me-3 text-info">
                                                <i class="fas fa-glass-water fa-lg"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0">Günlük su tüketiminize dikkat edin. Yetişkinler için günde ortalama 2-2.5 litre su içilmesi önerilir.</p>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                                {% endif %}
                                
                                <div class="alert alert-warning mt-3 mb-0 d-flex align-items-center small">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <div>Bu öneriler, tahlil sonuçlarınızın yapay zeka analizine dayanmaktadır. Sağlık durumunuz hakkında kesin bilgi için mutlaka bir sağlık uzmanına danışmalısınız.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Uyarı -->
                    <div class="alert alert-warning d-flex" role="alert">
                        <div class="me-3">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                        <div>
                            <h5 class="alert-heading">Önemli Uyarı</h5>
                            <p class="mb-0">Bu analiz sadece bilgilendirme amaçlıdır ve profesyonel tıbbi tavsiye yerine geçmez. Sağlık durumunuz hakkında endişeleriniz varsa, lütfen bir sağlık uzmanına danışın.</p>
                        </div>
                    </div>
                    
                    <!-- Tahlil İçeriği -->
                    <div class="accordion mt-4" id="tahlilAccordion">
                        <div class="accordion-item border-0 shadow-sm">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                    <i class="fas fa-file-medical me-2"></i> Tahlil İçeriği (İlk 1000 karakter)
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#tahlilAccordion">
                                <div class="accordion-body bg-light">
                                    <pre class="mb-0 text-muted small">{{ analysis.analysis_text }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer Actions -->
                <div class="card-footer bg-white py-3 d-flex justify-content-between">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Panele Dön
                    </a>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="window.print()">
                            <i class="fas fa-print me-1"></i>Yazdır
                        </button>
                        <a href="{{ url_for('analyze') }}" class="btn btn-primary">
                            <i class="fas fa-file-upload me-1"></i>Yeni Tahlil Yükle
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Paylaşım Seçenekleri -->
            <div class="d-flex justify-content-center mt-4">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-envelope me-1"></i>E-posta ile Gönder
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-file-pdf me-1"></i>PDF Olarak İndir
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-share-alt me-1"></i>Paylaş
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js kütüphanesi -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Trend grafiği için veri
        const comparisonData = {{ comparison_data|tojson }};
        
        // Trend grafiği oluştur (varsa)
        if (Object.keys(comparisonData).length > 0) {
            let trendChart;
            const paramSelect = document.getElementById('param-select');
            
            function updateChart(paramName) {
                if (!paramName || !comparisonData[paramName]) return;
                
                // Veriyi hazırla
                const chartData = comparisonData[paramName] || [];
                
                // Şu anki değeri ekle
                const testValues = {{ test_values|tojson }};
                const currentValue = testValues ? testValues.find(v => v.parameter_name === paramName) : null;
                if (currentValue) {
                    chartData.push({
                        date: '{{ analysis.created_at.split()[0] }}',
                        value: isNaN(parseFloat(currentValue.value)) ? currentValue.value : parseFloat(currentValue.value)
                    });
                }
                
                // Tarihleri ve değerleri ayır
                const dates = chartData.map(item => item.date);
                const values = chartData.map(item => {
                    if (typeof item.value === 'number') {
                        return item.value;
                    }
                    const parsedValue = parseFloat(item.value);
                    return isNaN(parsedValue) ? 0 : parsedValue;
                });
                
                // Grafiği güncelle veya oluştur
                if (trendChart) {
                    trendChart.data.labels = dates;
                    trendChart.data.datasets[0].data = values;
                    trendChart.update();
                } else {
                    const ctx = document.getElementById('trendChart');
                    if (!ctx) return;
                    
                    trendChart = new Chart(ctx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: paramName,
                                data: values,
                                backgroundColor: 'rgba(13, 110, 253, 0.2)',
                                borderColor: 'rgba(13, 110, 253, 1)',
                                borderWidth: 2,
                                tension: 0.1,
                                pointBackgroundColor: 'rgba(13, 110, 253, 1)',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 8,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: ${context.raw}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            return value;
                                        }
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // İlk parametre için grafiği oluştur
            if (paramSelect && paramSelect.value) {
                updateChart(paramSelect.value);
            }
            
            // Parametre değişimini dinle
            if (paramSelect) {
                paramSelect.addEventListener('change', function() {
                    updateChart(this.value);
                });
            }
        }
    });
</script>
{% endblock %}